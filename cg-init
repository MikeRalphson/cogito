#!/usr/bin/env bash
#
# Initialize a GIT repository.
# Copyright (c) Petr Baudis, 2005
#
# Takes an optional parameter which will make it "clone" a specified
# remote repository.

. cg-Xlib

uri=$1

[ -e .git ] && die ".git already exists"

git-init-db
mkdir .git/branches .git/refs .git/refs/heads .git/refs/tags
touch .git/refs/heads/master
ln -s refs/heads/master .git/HEAD

if [ "$uri" ]; then
	echo "$uri" >.git/branches/origin
	cg-pull origin || die "pull failed"

	cp .git/refs/heads/origin .git/refs/heads/master
	git-read-tree HEAD
	git-checkout-cache -a
	git-update-cache --refresh

	echo "Cloned (origin $uri available as branch \"origin\")"
else
	git-read-tree # Seed the dircache
	find * | xargs cg-add
	cg-commit -C -m"Initial commit" -e
fi
exit 0
